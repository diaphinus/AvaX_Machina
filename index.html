<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AvaX_Machina Subscription</title>
</head>
<body>
    <h1>Choose Your Subscription Plan</h1>
    <p>Unlock premium features with our monthly subscription.</p>

    <div style="max-width: 300px; margin: 20px auto; padding: 20px; border: 1px solid #ccc; border-radius: 8px; text-align: center;">
        <h2>Premium Plan</h2>
        <p>Access to all AvaX_Machina features, unlimited queries.</p>
        <p><strong>$X.XX/month</strong></p>
        <div id="paypal-button-container-P-7RG75175XD3884154NBK4J2Q"></div>
    </div>

    <script src="https://www.paypal.com/sdk/js?client-id=YOUR_PAYPAL_CLIENT_ID&vault=true&intent=subscription" data-sdk-integration-source="button-factory"></script>
    <script>
        // Replace 'YOUR_PAYPAL_CLIENT_ID' and 'YOUR_BACKEND_API_URL'
        const PAYPAL_PLAN_ID = 'P-7RG75175XD3884154NBK4J2Q'; // Your plan ID from PayPal
        const YOUR_BACKEND_API_URL = 'https://your-serverless-domain.com/api/paypal-subscription-approved';

        paypal.Buttons({
            style: {
                shape: 'rect',
                color: 'gold',
                layout: 'vertical',
                label: 'subscribe'
            },
            createSubscription: function(data, actions) {
                return actions.subscription.create({
                    plan_id: PAYPAL_PLAN_ID
                });
            },
            onApprove: function(data, actions) {
                const userAuthToken = localStorage.getItem('userAuthToken');
                if (!userAuthToken) {
                    alert('You must be logged in to subscribe.');
                    return;
                }
                fetch(YOUR_BACKEND_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${userAuthToken}`
                    },
                    body: JSON.stringify({
                        paypalSubscriptionID: data.subscriptionID,
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || 'Server error'); });
                    }
                    return response.json();
                })
                .then(serverData => {
                    if (serverData.success) {
                        alert('Subscription successful! You now have premium access.');
                        window.location.href = '/dashboard?status=subscribed';
                    } else {
                        alert(`Subscription failed: ${serverData.message}. Please contact support.`);
                    }
                })
                .catch(error => {
                    alert('An unexpected error occurred during subscription. Please try again.');
                });
            },
            onCancel: function(data) {
                alert('Subscription process cancelled.');
            },
            onError: function(err) {
                alert('An error occurred with the PayPal button. Please try again.');
            }
        }).render('#paypal-button-container-P-7RG75175XD3884154NBK4J2Q');
    </script>
</body>
</html>
